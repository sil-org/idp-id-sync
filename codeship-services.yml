app:
    build:
        image: silintl/idp-id-sync
        dockerfile_path: ./Dockerfile
        cached: true
    ports:
        - "80"
    working_dir: /data
    command: /data/run-tests.sh
    environment:
        APP_ENV: test
        ID_BROKER_ADAPTER: fake
        ID_BROKER_ACCESS_TOKEN: anything
        ID_STORE_ADAPTER: fake
        ID_SYNC_ACCESS_TOKENS: abc123
        TEST_ID_SYNC_BASE_URL: http://localhost

broker:
    image: silintl/idp-id-broker:develop
    environment:
        API_ACCESS_KEYS: local-sync-123
        IDP_NAME: local
        MYSQL_ROOT_PASSWORD: rootpass
        MYSQL_HOST: brokerdb
        MYSQL_DATABASE: broker
        MYSQL_USER: broker
        MYSQL_PASSWORD: broker
    ports:
        - "8081:80"
    command: whenavail brokerdb 3306 20 ./run.sh

brokerdb:
    image: silintl/mariadb:latest
    ports:
        - "3306"
    environment:
        MYSQL_ROOT_PASSWORD: rootpass
        MYSQL_DATABASE: broker
        MYSQL_USER: broker
        MYSQL_PASSWORD: broker
